name: Documentation

on:
  push:
    branches:
    - development
    tags:
    - 3.1.*
  pull_request:
    branches:
    - development
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag version to deploy (e.g., 3.1.1.0.0). Leave empty to deploy dev.'
        required: false

permissions:
  contents: write

concurrency:
  group: docs-deploy
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ inputs.version || github.ref }}
    - uses: prefix-dev/setup-pixi@v0.9.4
      with:
        pixi-version: v0.65.0
        environments: docs
        activate-environment: docs

    - name: Build documentation
      if: github.event_name == 'pull_request'
      run: pixi r docs-build

    - name: Configure git
      if: github.event_name != 'pull_request'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Remove stale versions
      if: github.event_name != 'pull_request'
      run: |
        for v in $(pixi r mike list | grep -oP '^\S+' | grep -v -E '^(dev|3\.)'); do
          pixi r mike delete --push "$v"
        done

    - name: Deploy dev docs
      if: github.ref == 'refs/heads/development' && !inputs.version
      run: |
        pixi r mike deploy --push --update-aliases dev latest
        if ! pixi r mike list | grep -q stable; then
          pixi r mike set-default --push latest
        fi

    - name: Deploy tagged version
      if: startsWith(github.ref, 'refs/tags/3.1.') || inputs.version
      run: |
        if [ -n "${{ inputs.version }}" ]; then
          VERSION="${{ inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        pixi r mike deploy --push --update-aliases "$VERSION" stable
        pixi r mike set-default --push stable
